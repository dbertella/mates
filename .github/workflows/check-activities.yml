# Ping the Ilford activities API once per hour; send email when a new
# Sunday Americano or Lunchtime Masterclass is published.
name: Check new activities

on:
  schedule:
    # Every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual run

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Restore activity state
        uses: actions/cache/restore@v4
        with:
          path: .activity-state
          key: padel-activities-state

      - name: Check for new activities
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_SECURE: ${{ secrets.SMTP_SECURE }}
          ACTIVITY_STATE_FILE: ${{ github.workspace }}/.activity-state/state.json
          AUTH_TOKEN: ${{ secrets.PADELMATES_AUTH_TOKEN }}
        run: node scripts/check-new-activities.js

      - name: Save activity state
        uses: actions/cache/save@v4
        with:
          path: .activity-state
          key: padel-activities-state
